// ===== MAIN PORTFOLIO APPLICATION =====

class PortfolioApp {
    constructor() {
        // State
        this.currentTheme = localStorage.getItem('theme') || 'dark';
        this.currentLang = localStorage.getItem('language') || 'vi';
        this.isNavOpen = false;
        this.isFabOpen = false;
        this.lastScrollY = 0;

        // Modals
        this.modals = {};

        // Config
        this.config = {
            scrollThreshold: 100,
            academic: {
                startDate: '2023-09-01',
                endDate: '2027-07-31',
                totalSemesters: 9,
                currentSemester: 5,
                gpa: 3.31
            },
            visitorCounterNamespace: 'trinhhoangtu-portfolio-2'
        };

        this.projectDetails = {
            'face-recognition': { title: 'Face / Object Recognition', link: '' },
            'yodobashi': { title: 'Yodobashi Sniper V2', link: '' },
            'portfolio': { title: 'Portfolio Website', link: '' },
            'flight': { title: 'Flight Reservation System', link: '' },
            'linux-manager': { title: 'Linux Server Manager', link: '' },
            'ereader': { title: 'EReader', link: '' },
            'chat': { title: 'Chat Application', link: '' },
            'english': { title: 'English Master', link: '' }
        };

        // Translations
        this.translations = {
            en: {
                // Page Title
                page_title: "Trinh Hoang Tu Portfolio",

                // Navigation
                nav_home: "Home",
                nav_about: "About",
                nav_skills: "Skills",
                nav_projects: "Projects",
                nav_certificates: "Certificates",
                nav_contact: "Contact",

                // Hero Section
                hero_greeting: "Hello, I'm",
                hero_subtitle_static: "Cybersecurity Enthusiast & Developer",
                hero_description: "Passionate about securing digital landscapes and crafting innovative solutions with cutting-edge technologies.",
                hero_btn_work: "View My Work",
                hero_btn_contact: "Get In Touch",

                // Academic Progress
                progress_label: "Academic Journey",

                // About Section
                about_title: "About Me",
                about_subtitle: "Get to know me",
                about_desc_1: "I'm a cybersecurity enthusiast and developer currently pursuing my degree in Information Technology at HUFLIT.",
                about_desc_2: "I would love to expand my knowledge and contribute to the tech community.",
                about_stat_1: "Credits Completed",
                about_stat_2: "Projects Built",
                about_stat_3: "Technologies Used",
                about_btn_cv: "Download CV",

                // Skills Section
                skills_title: "Skills & Technologies",
                skills_subtitle: "Tools and technologies I work with",
                skills_cat_1: "Programming Languages",
                skills_cat_2: "Frameworks & Tools",
                skills_cat_3: "Cybersecurity",

                // Projects Section
                projects_title: "Featured Projects",
                projects_subtitle: "Some of my recent work",
                projects_btn_all: "View All Projects",
                projects_btn_details: "View Details",

                // GDG Section
                gdg_title: "Google Developer Group",
                gdg_desc: "Active member of GDG Ho Chi Minh City, participating in tech events and contributing to the developer community.",
                gdg_stat_1: "Events",
                gdg_stat_2: "Connections",
                gdg_stat_3: "Months",
                gdg_btn_profile: "Visit my GDG Profile",

                // Contact Section
                contact_title: "Let's Connect",
                contact_subtitle: "Get in touch for opportunities or collaborations",
                contact_item_1: "Email",
                contact_item_2: "Location",
                contact_item_3: "University",
                contact_card_linkedin: "Professional Network",
                contact_card_github: "Code Repository",
                contact_card_leetcode: "Problem Solving",
                contact_card_tiktok: "Educational Content",
                contact_card_facebook: "Social Updates",
                contact_card_discord: "Private Message",

                // Footer
                footer_tagline: "Building the future, one line of code at a time.",
                footer_nav: "Navigation",
                footer_connect: "Connect",
                footer_built: "Built with",
                footer_rights: "All rights reserved.",
                footer_university: "HUFLIT â€¢ Information Technology",
                footer_visitors: "visitors",
                footer_last_updated: "Last updated:",

                // FAB Menu
                fab_top: "Back to Top",
                fab_cv: "View CV",
                fab_share: "Share Profile",

                // Modals
                modal_cv_title: "Curriculum Vitae",
                modal_cv_print: "Print",
                modal_cv_download: "Download PDF",
                modal_progress_title: "Academic Progress Details",
                modal_progress_semesters: "Semesters",
                modal_progress_credits: "Credits",
                modal_progress_gpa: "GPA",
                modal_progress_grad: "Expected Graduation",
                modal_progress_y1_title: "Year 1: Foundations",
                modal_progress_y1_desc: "Completed C# programming fundamentals and basic computer science concepts",
                modal_progress_y2_title: "Year 2: Advanced Programming",
                modal_progress_y2_desc: "Focused on advanced C#, Java, Python, and web development",
                modal_progress_y3_title: "Year 3: Deepening Knowledge",
                modal_progress_y3_desc: "Currently diving deep into cybersecurity and advanced IT concepts",
                modal_progress_y4_title: "Year 4: Graduation",
                modal_progress_y4_desc: "Capstone project, internship, and graduation preparation",
                modal_project_title: "Project Details",

                // Projects Page
                projects_page_title: "My Projects",
                projects_page_subtitle: "Exploring my journey through various creations",
                projects_page_stat_1: "Completed Projects",
                projects_page_stat_2: "Languages",
                projects_page_stat_3: "Technologies",
                projects_page_filter_all: "All",
                projects_page_filter_web: "Web",
                projects_page_filter_desktop: "Desktop",
                projects_page_filter_mobile: "Mobile",
                projects_page_filter_backend: "Backend",
                projects_page_filter_extension: "Extension",
                projects_page_btn_back: "Back",

                // Certificates Page
                cert_page_title: "Certificates",
                cert_page_subtitle: "A collection of my certifications and achievements.",
                                                cert_view_button: "PhÃ³ng to",

                cert_achievement_title: "ThÃ nh tá»±u",
                cert_achievement_desc: "ÄÆ°á»£c trao bá»Ÿi Huyá»‡n BÃ¹ ÄÄƒng, Tá»‰nh BÃ¬nh PhÆ°á»›c.",

                // Dynamic Content
                typing_texts: [
                    'Cybersecurity Enthusiast & Developer',
                    'Google Developer Group Member',
                    'Full-Stack Developer',
                    'Security Researcher',
                    'Problem Solver'
                ],
                project_desc_face_recognition: 'Engineered a multi-threaded Java server using TCP sockets secured with SSL/TLS encryption. Developed a Python microservice exposing a REST API (Flask/FastAPI), leveraging OpenCV and face_recognition. Java server communicates securely with the Python service over HTTPS for inference, returning results to clients.',
                project_desc_yodobashi: 'Advanced browser extension for automated product purchasing. Built with modern JavaScript (ES6+), Chrome APIs, and robust testing.',
                project_desc_portfolio: 'Personal portfolio website designed with a modern, responsive interface and multi-language support.',
                project_desc_flight: 'Flight reservation system developed with ASP.NET C#, providing a friendly interface and effective booking management.',
                project_desc_linux_manager: 'Linux server management desktop application (WPF C#), acting as a powerful SSH client using the SSH.NET library.',
                project_desc_ereader: 'Feature-rich e-book reader application with a customizable interface, bookmarking, and reading progress tracking.',
                project_desc_chat: 'Real-time chat application using WebSockets and Java, supporting group chat and private messages.',
                project_desc_english: 'Android English learning application with interactive lessons and a progress tracking system.',
            },
            vi: {
                // Page Title
                page_title: "Portfolio Trá»‹nh HoÃ ng TÃº",

                // Navigation
                nav_home: "Trang chá»§",
                nav_about: "Vá» tÃ´i",
                nav_skills: "Ká»¹ nÄƒng",
                nav_projects: "Dá»± Ã¡n",
                nav_certificates: "Chá»©ng chá»‰",
                nav_contact: "LiÃªn há»‡",

                // Hero Section
                hero_greeting: "Xin chÃ o, tÃ´i lÃ ",
                hero_subtitle_static: "NgÆ°á»i Ä‘am mÃª An ninh máº¡ng & Láº­p trÃ¬nh viÃªn",
                hero_description: "Há»©ng thÃº trong viá»‡c Ã¡p dá»¥ng kiáº¿n thá»©c an ninh máº¡ng vÃ o xÃ¢y dá»±ng há»‡ thá»‘ng web vÃ  á»©ng dá»¥ng di Ä‘á»™ng an toÃ n, dá»… má»Ÿ rá»™ng.",
                hero_btn_work: "Xem sáº£n pháº©m",
                hero_btn_contact: "LiÃªn há»‡ ngay",

                // Academic Progress
                progress_label: "HÃ nh trÃ¬nh há»c táº­p",

                // About Section
                about_title: "Vá» báº£n thÃ¢n",
                about_subtitle: "Äá»ƒ hiá»ƒu rÃµ hÆ¡n vá» tÃ´i",
                about_desc_1: "TÃ´i lÃ  má»™t ngÆ°á»i Ä‘am mÃª an ninh máº¡ng vÃ  lÃ  láº­p trÃ¬nh viÃªn, hiá»‡n Ä‘ang theo há»c ngÃ nh CÃ´ng nghá»‡ ThÃ´ng tin táº¡i Äáº¡i há»c HUFLIT. Vá»›i niá»m Ä‘am mÃª mÃ£nh liá»‡t cho cáº£ báº£o máº­t vÃ  phÃ¡t triá»ƒn, tÃ´i thÃ­ch khÃ¡m phÃ¡ sá»± giao thoa cá»§a hai lÄ©nh vá»±c nÃ y.",
                about_desc_2: "TÃ´i ráº¥t muá»‘n má»Ÿ rá»™ng kiáº¿n thá»©c vÃ  Ä‘Ã³ng gÃ³p cho cá»™ng Ä‘á»“ng cÃ´ng nghá»‡.",
                about_stat_1: "TÃ­n chá»‰ Ä‘Ã£ hoÃ n thÃ nh",
                about_stat_2: "Dá»± Ã¡n Ä‘Ã£ xÃ¢y dá»±ng",
                about_stat_3: "CÃ´ng nghá»‡ Ä‘Ã£ sá»­ dá»¥ng",
                about_btn_cv: "Táº£i xuá»‘ng CV",

                // Skills Section
                skills_title: "Ká»¹ nÄƒng & CÃ´ng nghá»‡",
                skills_subtitle: "CÃ¡c cÃ´ng cá»¥ vÃ  cÃ´ng nghá»‡ tÃ´i lÃ m viá»‡c",
                skills_cat_1: "NgÃ´n ngá»¯ láº­p trÃ¬nh",
                skills_cat_2: "Frameworks & CÃ´ng cá»¥",
                skills_cat_3: "An ninh máº¡ng",

                // Projects Section
                projects_title: "Dá»± Ã¡n ná»•i báº­t",
                projects_subtitle: "Má»™t vÃ i sáº£n pháº©m gáº§n Ä‘Ã¢y cá»§a tÃ´i",
                projects_btn_all: "Xem táº¥t cáº£ dá»± Ã¡n",
                projects_btn_details: "Xem chi tiáº¿t",

                // GDG Section
                gdg_title: "Google Developer Group",
                gdg_desc: "LÃ  thÃ nh viÃªn tÃ­ch cá»±c cá»§a GDG TP. Há»“ ChÃ­ Minh, tham gia cÃ¡c sá»± kiá»‡n cÃ´ng nghá»‡ vÃ  Ä‘Ã³ng gÃ³p cho cá»™ng Ä‘á»“ng láº­p trÃ¬nh viÃªn.",
                gdg_stat_1: "Sá»± kiá»‡n",
                gdg_stat_2: "Káº¿t ná»‘i",
                gdg_stat_3: "ThÃ¡ng",
                gdg_btn_profile: "Xem há»“ sÆ¡ GDG cá»§a tÃ´i",

                // Contact Section
                contact_title: "Káº¿t ná»‘i",
                contact_subtitle: "LiÃªn há»‡ Ä‘á»ƒ trao Ä‘á»•i cÆ¡ há»™i hoáº·c há»£p tÃ¡c",
                contact_item_1: "Email",
                contact_item_2: "Vá»‹ trÃ­",
                contact_item_3: "TrÆ°á»ng Ä‘áº¡i há»c",
                contact_card_linkedin: "Máº¡ng lÆ°á»›i chuyÃªn nghiá»‡p",
                contact_card_github: "Kho mÃ£ nguá»“n",
                contact_card_leetcode: "Giáº£i quyáº¿t váº¥n Ä‘á»",
                contact_card_tiktok: "Ná»™i dung giÃ¡o dá»¥c",
                contact_card_facebook: "Cáº­p nháº­t xÃ£ há»™i",
                contact_card_discord: "Tin nháº¯n riÃªng",

                // Footer
                footer_tagline: "XÃ¢y dá»±ng tÆ°Æ¡ng lai, má»—i láº§n má»™t dÃ²ng mÃ£.",
                footer_nav: "Äiá»u hÆ°á»›ng",
                footer_connect: "Káº¿t ná»‘i",
                footer_built: "XÃ¢y dá»±ng vá»›i",
                footer_rights: "Báº£n quyá»n Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½.",
                footer_university: "HUFLIT â€¢ CÃ´ng nghá»‡ thÃ´ng tin",
                footer_visitors: "lÆ°á»£t xem",
                footer_last_updated: "Cáº­p nháº­t láº§n cuá»‘i:",

                // FAB Menu
                fab_top: "LÃªn Ä‘áº§u trang",
                fab_cv: "Xem CV",
                fab_share: "Chia sáº» há»“ sÆ¡",

                // Modals
                modal_cv_title: "Há»“ sÆ¡ nÄƒng lá»±c (CV)",
                modal_cv_print: "In",
                modal_cv_download: "Táº£i PDF",
                modal_progress_title: "Chi tiáº¿t tiáº¿n Ä‘á»™ há»c táº­p",
                modal_progress_semesters: "Há»c ká»³",
                modal_progress_credits: "TÃ­n chá»‰",
                modal_progress_gpa: "Äiá»ƒm trung bÃ¬nh",
                modal_progress_grad: "Tá»‘t nghiá»‡p dá»± kiáº¿n",
                modal_progress_y1_title: "NÄƒm 1: Ná»n táº£ng",
                modal_progress_y1_desc: "HoÃ n thÃ nh cÃ¡c kiáº¿n thá»©c cÆ¡ báº£n vá» láº­p trÃ¬nh C# vÃ  khoa há»c mÃ¡y tÃ­nh",
                modal_progress_y2_title: "NÄƒm 2: Láº­p trÃ¬nh nÃ¢ng cao",
                modal_progress_y2_desc: "ThÃ nh tháº¡o C# nÃ¢ng cao, Java, Python vÃ  phÃ¡t triá»ƒn web",
                modal_progress_y3_title: "NÄƒm 3: ChuyÃªn ngÃ nh",
                modal_progress_y3_desc: "Hiá»‡n Ä‘ang tÃ¬m hiá»ƒu sÃ¢u vá» an ninh máº¡ng vÃ  cÃ¡c khÃ¡i niá»‡m CNTT tiÃªn tiáº¿n",
                modal_progress_y4_title: "NÄƒm 4: Tá»‘t nghiá»‡p",
                modal_progress_y4_desc: "Äá»“ Ã¡n tá»‘t nghiá»‡p, thá»±c táº­p vÃ  chuáº©n bá»‹ tá»‘t nghiá»‡p",
                modal_project_title: "Chi tiáº¿t dá»± Ã¡n",

                // Projects Page
                projects_page_title: "Dá»± Ã¡n cá»§a tÃ´i",
                projects_page_subtitle: "KhÃ¡m phÃ¡ hÃ nh trÃ¬nh cá»§a tÃ´i qua cÃ¡c sÃ¡ng táº¡o khÃ¡c nhau",
                projects_page_stat_1: "Dá»± Ã¡n Ä‘Ã£ hoÃ n thÃ nh",
                projects_page_stat_2: "NgÃ´n ngá»¯",
                projects_page_stat_3: "CÃ´ng nghá»‡",
                projects_page_filter_all: "Táº¥t cáº£",
                projects_page_filter_web: "Web",
                projects_page_filter_desktop: "Desktop",
                projects_page_filter_mobile: "Di Ä‘á»™ng",
                projects_page_filter_backend: "Backend",
                projects_page_filter_extension: "Extension",
                projects_page_btn_back: "Trá»Ÿ vá»",

                // Certificates Page
                cert_page_title: "Chá»©ng chá»‰",
                                cert_page_subtitle: "Bá»™ sÆ°u táº­p cÃ¡c chá»©ng chá»‰ vÃ  thÃ nh tá»±u cá»§a tÃ´i.",
                cert_view_button: "PhÃ³ng to",

                // Dynamic Content
                typing_texts: [
                    'NgÆ°á»i Ä‘am mÃª An ninh máº¡ng & Láº­p trÃ¬nh viÃªn',
                    'ThÃ nh viÃªn Google Developer Group',
                    'Láº­p trÃ¬nh viÃªn Full-Stack',
                    'NghiÃªn cá»©u báº£o máº­t',
                    'Giáº£i quyáº¿t váº¥n Ä‘á»'
                ],
                project_desc_face_recognition: 'Thiáº¿t káº¿ má»™t mÃ¡y chá»§ Java Ä‘a luá»“ng sá»­ dá»¥ng TCP socket Ä‘Æ°á»£c báº£o máº­t báº±ng mÃ£ hÃ³a SSL/TLS. PhÃ¡t triá»ƒn má»™t microservice Python vá»›i REST API (Flask/FastAPI), táº­n dá»¥ng OpenCV vÃ  face_recognition. MÃ¡y chá»§ Java giao tiáº¿p an toÃ n vá»›i dá»‹ch vá»¥ Python qua HTTPS Ä‘á»ƒ thá»±c hiá»‡n nháº­n dáº¡ng vÃ  tráº£ káº¿t quáº£ vá» cho client.',
                project_desc_yodobashi: 'Tiá»‡n Ã­ch má»Ÿ rá»™ng trÃ¬nh duyá»‡t nÃ¢ng cao Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a quy trÃ¬nh mua sáº£n pháº©m. ÄÆ°á»£c xÃ¢y dá»±ng báº±ng JavaScript hiá»‡n Ä‘áº¡i (ES6+), Chrome API vÃ  kiá»ƒm thá»­ ká»¹ lÆ°á»¡ng.',
                project_desc_portfolio: 'Trang web portfolio cÃ¡ nhÃ¢n Ä‘Æ°á»£c thiáº¿t káº¿ vá»›i giao diá»‡n hiá»‡n Ä‘áº¡i, responsive vÃ  há»— trá»£ Ä‘a ngÃ´n ngá»¯.',
                project_desc_flight: 'Há»‡ thá»‘ng Ä‘áº·t vÃ© mÃ¡y bay Ä‘Æ°á»£c phÃ¡t triá»ƒn báº±ng ASP.NET C#, cung cáº¥p giao diá»‡n thÃ¢n thiá»‡n vÃ  quáº£n lÃ½ Ä‘áº·t chá»— hiá»‡u quáº£.',
                project_desc_linux_manager: 'á»¨ng dá»¥ng quáº£n lÃ½ mÃ¡y chá»§ Linux dÃ nh cho mÃ¡y tÃ­nh Ä‘á»ƒ bÃ n (WPF C#), hoáº¡t Ä‘á»™ng nhÆ° má»™t SSH client máº¡nh máº½ sá»­ dá»¥ng thÆ° viá»‡n SSH.NET.',
                project_desc_ereader: 'á»¨ng dá»¥ng Ä‘á»c sÃ¡ch Ä‘iá»‡n tá»­ giÃ u tÃ­nh nÄƒng vá»›i giao diá»‡n tÃ¹y chá»‰nh, Ä‘Ã¡nh dáº¥u vÃ  theo dÃµi tiáº¿n trÃ¬nh Ä‘á»c.',
                project_desc_chat: 'á»¨ng dá»¥ng chat thá»i gian thá»±c sá»­ dá»¥ng WebSocket vÃ  Java, há»— trá»£ chat nhÃ³m vÃ  tin nháº¯n cÃ¡ nhÃ¢n.',
                project_desc_english: 'á»¨ng dá»¥ng há»c tiáº¿ng Anh trÃªn Android vá»›i cÃ¡c bÃ i há»c tÆ°Æ¡ng tÃ¡c vÃ  há»‡ thá»‘ng theo dÃµi tiáº¿n trÃ¬nh há»c táº­p.',
            }
        };

        // Initialize after DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.init());
        } else {
            this.init();
        }
    }

    init() {
        console.log("ðŸš€ Portfolio Initializing...");
        this.initTheme();
        this.initLanguage();
        this.initNavigation();
        this.initScrollHandlers();
        this.initParticles();
        this.initModals();
        this.initFAB();
        this.initAnimations();
        this.initTypingEffect();
        this.initProgressBar();
        this.initVisitorCounter();
        this.initLoadingScreen();
        this.initProjectCardListeners();
        this.initProjectsPage();
        this.initCertificateModal();
        this.bindEvents();
        console.log("âœ… Portfolio Initialized Successfully!");
    }

    initCertificateModal() {
        if (!document.getElementById('certificates-page')) return;

        const modal = document.getElementById('certModal');
        const modalImg = document.getElementById('certModalImage');
        const closeBtn = document.getElementById('closeCertModal');

        if (!modal || !modalImg || !closeBtn) return;

        document.querySelectorAll('.view-cert-btn, .cert-image-preview').forEach(el => {
            el.addEventListener('click', (e) => {
                let imgSrc = e.currentTarget.dataset.imgSrc || e.currentTarget.getAttribute('src');
                modal.classList.add('active');
                modalImg.src = imgSrc;
                document.body.style.overflow = 'hidden';
            });
        });

        const closeModal = () => {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    }

    bindEvents() {
        // Theme Toggle
        document.getElementById('themeToggle')?.addEventListener('click', () => this.toggleTheme());

        // Language Toggle
        document.getElementById('langToggle')?.addEventListener('click', () => this.toggleLanguage());

        // Nav Menu
        document.getElementById('navToggle')?.addEventListener('click', () => this.toggleNavMenu());
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href').includes('#')) {
                    e.preventDefault();
                    this.scrollToSection(link.getAttribute('href').substring(1));
                    this.closeNavMenu();
                }
            });
        });

        // FAB
        document.getElementById('mainFab')?.addEventListener('click', () => this.toggleFAB());
        document.getElementById('backToTop')?.addEventListener('click', () => this.scrollToTop());
        document.getElementById('viewCV')?.addEventListener('click', () => this.openModal('cv'));
        
        // Modals
        document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') this.closeAllModals();
        });
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => this.closeAllModals());
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') this.closeAllModals();
        });
        
        // CV Download
        document.getElementById('downloadCV')?.addEventListener('click', () => this.openModal('cv'));
        
        // Progress Details
        document.getElementById('progressExpand')?.addEventListener('click', () => this.openModal('progress'));
    }

    // ===== PROJECTS PAGE SPECIFIC =====
    initProjectCardListeners() {
        document.querySelectorAll('.project-card .btn-outline').forEach(button => {
            const card = button.closest('.project-card');
            const projectId = card?.dataset.project;

            if (projectId) {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.openModal('project', projectId);
                });
            }
        });
    }

    initProjectsPage() {
        if (!document.getElementById('projects-page')) return;

        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.filterProjects(btn.dataset.filter);
            });
        });
    }

    filterProjects(category) {
        const projectCards = document.querySelectorAll('#projects-page .project-card');
        projectCards.forEach(card => {
            const cardCategory = card.dataset.category;
            if (category === 'all' || category === cardCategory) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    initModals() {
        this.modalOverlay = document.getElementById('modalOverlay');
        document.querySelectorAll('.modal').forEach(modal => {
            const modalName = modal.id.replace('Modal', '');
            this.modals[modalName] = modal;
        });
    }
    
    openModal(modalName, dataId = null) {
        // Hide all modals first
        Object.values(this.modals).forEach(m => {
            if (m) m.style.display = 'none';
        });

        const modal = this.modals[modalName];
        if (modal && this.modalOverlay) {
            if (modalName === 'project' && dataId) {
                const project = this.projectDetails[dataId];
                if (project) {
                    const description = this.translations[this.currentLang][`project_desc_${dataId}`] || '';
                    modal.querySelector('#projectModalTitle').textContent = project.title;
                    const body = modal.querySelector('.modal-body');
                    if(body) body.innerHTML = `<p>${description}</p>`;
                    const footer = modal.querySelector('.modal-footer');
                    if(footer) footer.innerHTML = `<a href="${project.link}" class="btn-primary" target="_blank">View on GitHub</a>`;
                }
            }

            this.modalOverlay.classList.add('active');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            modal.focus();
        }
    }

    closeAllModals() {
        if (this.modalOverlay) {
            Object.values(this.modals).forEach(modal => {
                if (modal && modal.style.display === 'block') {
                    modal.classList.add('closing');
                    modal.addEventListener('animationend', () => {
                        modal.classList.remove('closing');
                        modal.style.display = 'none';
                        this.modalOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }, { once: true });
                }
            });
        }
    }

    // ===== THEME =====
    initTheme() {
        this.applyTheme();
    }

    applyTheme() {
        document.body.dataset.theme = this.currentTheme;
        localStorage.setItem('theme', this.currentTheme);
    }

    toggleTheme() {
        this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        this.applyTheme();
    }

    // ===== LANGUAGE =====
    initLanguage() {
        this.translatePage();
    }

    toggleLanguage() {
        const elements = document.querySelectorAll('[data-i18n]');
        
        // Fade out all elements
        elements.forEach(el => {
            el.style.transition = 'opacity 0.2s ease-out';
            el.style.opacity = '0';
        });

        // After a short delay, change the text and fade back in
        setTimeout(() => {
            this.currentLang = this.currentLang === 'vi' ? 'en' : 'vi';
            localStorage.setItem('language', this.currentLang);
            this.translatePage();
            this.initTypingEffect();

            elements.forEach(el => {
                el.style.opacity = '1';
            });
        }, 200);
    }

    translatePage() {
        const trans = this.translations[this.currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (trans[key]) {
                el.textContent = trans[key];
            }
        });
        document.title = trans.page_title || "Trinh Hoang Tu Portfolio";
        const langToggle = document.getElementById('langToggle');
        if (langToggle) {
            langToggle.querySelector('.lang-current').textContent = this.currentLang.toUpperCase();
        }
    }

    // ===== NAVIGATION =====
    initNavigation() {
        this.navMenu = document.getElementById('navMenu');
        this.navToggle = document.getElementById('navToggle');
        this.navbar = document.getElementById('navbar');
    }

    toggleNavMenu() {
        this.isNavOpen = !this.isNavOpen;
        this.navMenu?.classList.toggle('active', this.isNavOpen);
        this.navToggle?.classList.toggle('active', this.isNavOpen);
    }

    closeNavMenu() {
        if (this.isNavOpen) {
            this.toggleNavMenu();
        }
    }
    
    scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            window.scrollTo({
                top: section.offsetTop - (this.navbar?.offsetHeight || 80), // Default height
                behavior: 'smooth'
            });
        }
    }

    // ===== SCROLL HANDLERS =====
    initScrollHandlers() {
        window.addEventListener('scroll', () => {
            if (window.scrollY > this.config.scrollThreshold) {
                this.navbar?.classList.add('scrolled');
            } else {
                this.navbar?.classList.remove('scrolled');
            }
            this.lastScrollY = window.scrollY;
        });
    }

    // ===== PARTICLES =====
    initParticles() {
        const container = document.getElementById('particlesContainer');
        if (!container) return;
        const particleCount = 50;
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
            particle.style.animationDelay = `${Math.random() * 5}s`;
            fragment.appendChild(particle);
        }
        container.appendChild(fragment);
    }

    // ===== FLOATING ACTION BUTTON (FAB) =====
    initFAB() {
        this.fabMenu = document.getElementById('fabMenu');
    }

    scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    toggleFAB() {
        this.isFabOpen = !this.isFabOpen;
        document.getElementById('mainFab')?.classList.toggle('active', this.isFabOpen);
        this.fabMenu?.classList.toggle('active', this.isFabOpen);
    }

    // ===== ANIMATIONS =====
    initAnimations() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animated');
                    observer.unobserve(entry.target);
                }
            });
        }, { rootMargin: '0px 0px -100px 0px', threshold: 0.1 });

        document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
    }

    // ===== TYPING EFFECT =====
    initTypingEffect() {
        const el = document.querySelector('.typing-text');
        if (!el) return;

        // Stop any previous typing animation
        if (this.typingTimeout) clearTimeout(this.typingTimeout);

        let textIndex = 0;
        let charIndex = 0;
        let isDeleting = false;
        const typingTexts = this.translations[this.currentLang].typing_texts || [];

        const type = () => {
            const currentText = typingTexts[textIndex];
            let typeSpeed = isDeleting ? 50 : 100;

            if (isDeleting) {
                el.textContent = currentText.substring(0, charIndex - 1);
                charIndex--;
            } else {
                el.textContent = currentText.substring(0, charIndex + 1);
                charIndex++;
            }

            if (!isDeleting && charIndex === currentText.length) {
                typeSpeed = 2000;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                textIndex = (textIndex + 1) % typingTexts.length;
                typeSpeed = 500;
            }

            this.typingTimeout = setTimeout(type, typeSpeed);
        };
        type();
    }

    // ===== PROGRESS BAR =====
    initProgressBar() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    this.animateProgressBar();
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.5 });

        const progressWidget = document.getElementById('progressWidget');
        if (progressWidget) observer.observe(progressWidget);
    }

    animateProgressBar() {
        const fill = document.getElementById('progressFill');
        const percentage = document.getElementById('progressPercentage');
        if (!fill || !percentage) return;

        const startDate = new Date(this.config.academic.startDate);
        const endDate = new Date(this.config.academic.endDate);
        const targetProgress = Math.min(((new Date() - startDate) / (endDate - startDate)) * 100, 100);

        let progress = 0;
        const duration = 2000;
        const startTime = Date.now();

        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progressRatio = Math.min(elapsed / duration, 1);
            progress = targetProgress * (1 - Math.pow(1 - progressRatio, 3)); // easeOutCubic

            fill.style.width = `${progress}%`;
            percentage.textContent = `${progress.toFixed(1)}%`;

            if (progressRatio < 1) requestAnimationFrame(animate);
        };
        animate();
    }

    // ===== VISITOR COUNTER =====
    initVisitorCounter() {
        const el = document.getElementById('visitorCount');
        if (!el) return;

        const key = `${this.config.visitorCounterNamespace}-count`;
        const visitedKey = `${this.config.visitorCounterNamespace}-visited`;

        // Check if the user has visited before
        if (localStorage.getItem(visitedKey)) {
            // If visited, just get the count without incrementing
            fetch(`https://api.countapi.xyz/get/${this.config.visitorCounterNamespace}/${key}`)
                .then(res => res.json())
                .then(data => {
                    el.textContent = data.value.toLocaleString();
                })
                .catch(() => {
                    el.textContent = 'N/A';
                });
        } else {
            // If not visited, increment the count and mark as visited
            fetch(`https://api.countapi.xyz/hit/${this.config.visitorCounterNamespace}/${key}`)
                .then(res => res.json())
                .then(data => {
                    el.textContent = data.value.toLocaleString();
                    localStorage.setItem(visitedKey, 'true');
                })
                .catch(() => {
                    el.textContent = 'N/A';
                });
        }
        
        // Also update footer date
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if(lastUpdatedEl) {
            lastUpdatedEl.textContent = new Date().toLocaleDateString('vi-VN');
        }
    }

    initLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 500); // 500ms delay
        }
    }
}

// Instantiate the app
new PortfolioApp();
